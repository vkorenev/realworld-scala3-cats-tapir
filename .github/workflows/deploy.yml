name: Deploy

on:
  push:
    branches:
      - master
  workflow_dispatch:

jobs:
  publish:
    name: Publish Container Image
    runs-on: ubuntu-latest
    permissions:
      contents: write
      id-token: write
    steps:
      - name: Checkout
        uses: actions/checkout@v6
      - name: Install SDKs and Tools
        uses: jdx/mise-action@v3
      - name: Parse Container Repository Name
        id: parse_container_repo
        env:
          CONTAINER_REPOSITORY_NAME: ${{ vars.CONTAINER_REPOSITORY_NAME }}
        run: |
          CONTAINER_REGISTRY="${CONTAINER_REPOSITORY_NAME%%/*}"
          CONTAINER_REPO_NAMESPACE="${CONTAINER_REPOSITORY_NAME#*/}"

          if [ "$CONTAINER_REGISTRY" = "$CONTAINER_REPO_NAMESPACE" ]; then
            echo "GitHub variable 'container_repository_name' must include at least one '/' separator." >&2
            exit 1
          fi

          echo "registry=${CONTAINER_REGISTRY}" >> $GITHUB_OUTPUT
          echo "namespace=${CONTAINER_REPO_NAMESPACE}" >> $GITHUB_OUTPUT
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v3
        with:
          project_id: ${{ vars.GCP_PROJECT }}
          workload_identity_provider: ${{ vars.GCP_WIF_PROVIDER }}
      - name: Configure Docker for Artifact Registry
        run: gcloud auth configure-docker ${{ steps.parse_container_repo.outputs.registry }}
      - name: Generate version
        id: version
        run: |
          VERSION="1.0.${GITHUB_RUN_NUMBER}"
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "Generated version: ${VERSION}"
      - name: Build Container Image
        env:
          PROJECT_VERSION: ${{ steps.version.outputs.version }}
        run: |
          sbt \
            "scalafmtCheckAll; scalafixAll --check; +test" \
            "set app / jibRegistry := \"${{ steps.parse_container_repo.outputs.registry }}\"" \
            "set app / jibOrganization := \"${{ steps.parse_container_repo.outputs.namespace }}\"" \
            "app / jibJavaDockerBuild"
      - name: Publish Container Image
        run: |
          docker push "${{ vars.CONTAINER_REPOSITORY_NAME }}/realworld-conduit-backend:${{ steps.version.outputs.version }}"
      - name: Update Dependency Graph
        uses: scalacenter/sbt-dependency-submission@v3
        with:
          configs-ignore: scala-tool scala-doc-tool test
